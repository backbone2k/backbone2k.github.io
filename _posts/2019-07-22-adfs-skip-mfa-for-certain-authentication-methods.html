---
layout: post
title: 'ADFS: Skip MFA for certain authentication methods'
date: 2019-07-22 20:24:19.000000000 +02:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Authentication
- Identity
tags:
- ADFS
- claim rules
- MFA
- multipleauthn
- office 365
meta:
  _wpas_skip_20268272: '1'
  _publicize_job_id: '33151091173'
  timeline_notification: '1563819859'
  publicize_linkedin_url: ''
  _publicize_done_21846260: '1'
  _wpas_done_22590086: '1'
author:
  login: cbaumgartner80
  email: wordpress@treegardner.de
  display_name: cbag
  first_name: Christian
  last_name: Baumgartner
permalink: "/2019/07/22/adfs-skip-mfa-for-certain-authentication-methods/"
excerpt: If you are using ADFS for authentication and you want to skip MFA for a user
  if a specific authentication mechanism was  used. In this post I show you one possible
  solution.
---
<p><!-- wp:paragraph --></p>
<p>If you are running a federated authentication with ADFS and your users are coming from outside of your organisation a second factor should be required after successful  authentication to get access to Office 365. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>But there are situations where you want to skip MFA for a user if a specific authentication mechanism was  used. For example if you are logging in with Azure MFA as primary authentication method, immediately getting a Azure MFA as second factor maybe does not make much sense. In this case it maybe ok to skip the second factor.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>So if you want to skip MFA while using Azure MFA as the primary authentication method when accessing Office 365 you can do this by modifying the issuance transform rules for Office 365 as follows</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>Modify default rule</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>First we have to remove one rule that ships with in default a default configuration (when setup with a recent version of AAD Connect):</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted"><code>@RuleName=&nbsp;"Pass through claim - multifactorauthenticationinstant"</code>
<code>c:[Type ==&nbsp;"http://schemas.microsoft.com/ws/2017/04/identity/claims/multifactorauthenticationinstant"]=&gt; issue(claim = c);</code></pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>The above rules get replaced by the following issuance transformation rules.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>Rule: Add custom claims to signal MFA skip </h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted"><code>@RuleName</code>&nbsp;<code>=&nbsp;"</code>Add custom claim to signal MFA skip<code>"</code>
<code>c:[Type ==&nbsp;"http://schemas.microsoft.com/claims/authnmethodsproviders", Value ==&nbsp;"AzurePrimaryAuthentication"]</code>
<code>=&gt; add(Type =&nbsp;"http://treeforest.cloud/skipMFA", Value =&nbsp;"skip");</code> </pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>The above rule checks the method used in the process of authentication. In  case it was <strong>AzurePrimaryAuthentication, </strong>we will add a custom claim with the value "skip" for the next rules. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted"><code>@RuleName</code>&nbsp;<code>=&nbsp;"</code>Add custom no skip<code> claim for other authn methods"</code> 
NOT EXISTS([Type == "<code>http://treeforest.cloud/skipMFA</code>"])
<code>=&gt; add(Type =&nbsp;"http://treeforest.cloud/skipMFA", Value =&nbsp;"no_skip");</code></pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>The second rule will add our custom claim only if AzurePrimaryAuthentication was <strong>NOT </strong>used. In this case we will send our custom claim with the value "no_skip". The order of these two rules is important - so keep an eye on it ;-)</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4 id="Story:ImplementationConceptforSSO,MFAandConditionalAccess-Rule:IssuemultipleauthnforAzureMFA">Rule: Issue multipleauthn for Azure MFA</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>If you are using Azure MFA as a primary authentication method, additional MFA can be suppressed with the following claim rule:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted"><code>@RuleName</code>&nbsp;<code>=&nbsp;"Issue multipleauthn for Azure MFA"</code>
<code>c:[Type ==&nbsp;"http://treeforest.cloud/skipMFA"</code>, Value == "skip"]
<code>=&gt; issue(Type =&nbsp;"http://schemas.microsoft.com/claims/authnmethodsreferences", Value =&nbsp;"http://schemas.microsoft.com/claims/multipleauthn");</code> </pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>If skipMFA with value "skip" is present this rule issues an <em>authnmethodsreference  </em>claim with the value <em>multipleauthn</em>. This value is later honored by ADFS access policies and/or Azure AD conditional access policies. So there will be no additional MFA triggered for the user if Azure MFA was used as an primary authentication method. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4 id="Story:ImplementationConceptforSSO,MFAandConditionalAccess-Rule:IssuemultifactorauthenticationinstantforAzureMfa">Rule: Issue multifactorauthenticationinstant for AzureMfa</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Just sending a "faked" multipleauthn reference is not enough. You also have to send out an UTC timestamp when the MFA authentication took place. Because we do not have this timestamp as a result of missing MFA we have to use another claim that is related to the authentication. The claim authenticationinstant contains the UTC timestamp for the primary authentication. Issuing this timestamp as multifactorauthenticationsinstant seems practical :-D</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted"><code>@RuleName</code> <code>= "Issue multifactorauthenticationinstant for AzureMfa"</code>
<code>c1:[Type == "http://treeforest.cloud/skipMFA", Value == "skip"] &amp;&amp; c2:[Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/authenticationinstant"]</code>
<code>=&gt; issue(Type = "http://schemas.microsoft.com/ws/2017/04/identity/claims/multifactorauthenticationinstant", Value = c2.Value);</code> </pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4 id="Story:ImplementationConceptforSSO,MFAandConditionalAccess-Rule:IssuemultifactorauthenticationinstantforAzureMfa">Rule: Issue multifactorauthenticationinstant clean up</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>This last rule will issue the default multifactorauthenticationinstant claim if no Azure MFA was used for authentication. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted"><code>@RuleName=&nbsp;"</code>multifactorauthenticationinstant clean up<code>"</code>
c1:[Type == <code>"http://treeforest.cloud/skipMFA", Value == "no_skip"]</code> &amp;&amp; <code>c2:[Type ==&nbsp;"http://schemas.microsoft.com/ws/2017/04/identity/claims/multifactorauthenticationinstant"]</code>
<code>=&gt; issue(claim = c2);</code></pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>Final thoughts</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Thats it! You now know how to fake the multipleauthn claim. But be care full - deciding to skip this additional measure can lead to an unsecure identity strategy. But in this special case, if an attacker already has access to the MFA app to provide the first factor, also the second factor shouldn't be a big problem. So skipping MFA in this case maybe not a big deal from an identity security perspective.</p>
<p><!-- /wp:paragraph --></p>
