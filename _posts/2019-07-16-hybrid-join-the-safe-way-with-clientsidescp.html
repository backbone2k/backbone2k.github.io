---
layout: post
title: Hybrid-Join the safe way with ClientSideSCP
date: 2019-07-16 08:28:56.000000000 +02:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Hybrid Join
- Workplace
tags:
- CDJ
- ClientSideSCP
- Windows 10
meta:
  _wpas_skip_20268272: '1'
  _publicize_job_id: '32907164508'
  timeline_notification: '1563258536'
  publicize_linkedin_url: ''
  _publicize_done_21846260: '1'
  _wpas_done_22590086: '1'
author:
  login: cbaumgartner80
  email: wordpress@treegardner.de
  display_name: cbag
  first_name: Christian
  last_name: Baumgartner
permalink: "/2019/07/16/hybrid-join-the-safe-way-with-clientsidescp/"
excerpt: If your organisation is transforming to Office 365 and wants to hybrid join
  Windows devices, this post will help you rolling out your first pilot devices without
  to worry for to much impacts. This approach also scales to a huge multi-forest environment.
---
<p><!-- wp:paragraph {"customFontSize":0} --></p>
<p style="font-size:0;">If your organisation is transforming to Office 365 and starting to consume more and more of its services, sooner or later (I recommend sooner is better üòÅ) you will think about joining your domain-joined devices also to Azure AD. There are a lot of benefits  you are getting from doing this which I do not want to cover in this post. Top reasons from my experience are:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li>smooth and secure way of authentication against Azure AD including SSO</li>
<li>better control for securing your Office 365 and Azure AD connected applications through more conditional access policies controls</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p>So joining your devices to Azure AD is a good idea! How to do this is covered in countless documentations. The steps for a controlled rollout in most companies consists of two steps:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list {"ordered":true} --></p>
<ol>
<li>Create a GPO to disable automatic join for Windows 10 and Windows Server 2016 for the majority of your devices. Only for a few pilot workplaces you want the GPO not be applied</li>
<li>Add an SCP in your local Active Directory pointing to one of your registered domains and the Azure AD tenant ID</li>
</ol>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p>If you are supporting a complex and quite large Active Directory forest or you even have multiple forests/domains, setting up GPOs and waiting for them to be replicated and applied can give you some headaches. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>The next hurdle oftens starts with the rights you need to create both the GPO and the SCP. Often the workplace team needs an domain or enterprise admin to assist in this task. And if you have more than one forest that should be part in your hybrid-join pilot maybe you have to talk to different IT guys from different subsidiaries to get the job done.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>But there is a very easy way to hybrid-join single devices without even touching your on-premise Active Directory now! The so called ClientSideSCP method. The only two requirements you need to fulfill are</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li>have local administrative rights on the machines you want to join. (You need to edit HKLM hive in the registry)</li>
<li>At least Win 10 1703 - better 1803 for different reasons (See my other blog: <a href="https://treeforest.cloud/2018/05/19/azure-hybrid-join-with-alternate-login-id-and-adfs/">https://treeforest.cloud/2018/05/19/azure-hybrid-join-with-alternate-login-id-and-adfs/</a>). Microsoft is writing in their documentation, that you need at least Windows 10 1607 to get ClientSideSCP to work, but my experience is that 1607 did not work. (I had a customer with Win 10 LTSB devices along with LTSC and the the LTSC did not work)</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p>Against the Microsoft documentation I recommend for the first  rollout to not apply the registry keys by a GPO, but instead add them manually to eliminate any dependencies/issues with GPOs.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3>Implementing ClientSideSCP  </h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>To have ClientSideSCP setup you have two (as a bonus I give you three üòä) options</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li><strong>Method 1 </strong>Create a GPO with the registry keys, scope it to the pilot machines, wait for AD replication to happen and run gpupdate /force. I already wrote in the chapter before, that I do not recommend this way personally</li>
<li><strong>Method 2</strong> Add the regkey and values by hand directly to the client(s)</li>
<li><strong>BONUS Method 3</strong> Use my <a href="https://github.com/backbone2k/setupClientSideSCP">script </a>that is doing the hard work for you (including collecting tenant id and domain name from Azure AD if you wish)</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>Method 2</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>just run regedit in elevated mode  on your pilot devices  and create the following key and add the two values:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">Hive:&nbsp;<strong>HKEY_LOCAL_MACHINE</strong><br />Key Path:&nbsp;<strong>SOFTWARE\Microsoft\Windows\CurrentVersion\CDJ\AAD</strong></pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">Value1 name:&nbsp;<strong>TenantId</strong><br />Value1 type:&nbsp;<strong>REG_SZ</strong><br />Value1 data: The GUID or&nbsp;<strong>Directory ID</strong>&nbsp;of your Azure AD instance</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">Value2 name:&nbsp;<strong>TenantName</strong><br />Value2 type:&nbsp;<strong>REG_SZ</strong><br />Value2 data: One verified&nbsp;<strong>domain name</strong>&nbsp;in Azure AD </pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>BONUS Method 3</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>If you as lazy as I am, just grab my super-duper-setupClientSideSCP-Powershell-Script from <a href="https://github.com/backbone2k/setupClientSideSCP">GitHub</a> and fire up an <strong>elevated </strong>Powershell 5+. If you want to run in full automatic mode you also need an Azure AD admin account and the  AzureAD Powershell module.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Starting in auto-mode is as simple as this (I love simple things ;-) )</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">PS &gt; SetupClientSideSCP.ps1</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>The semi-automatic mode can be startet with the following command:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">PS &gt; SetupClientSideSCP.ps1 -TenantId &lt;YOUR AZURE AD TENANT ID&gt; -TenantName &lt;ONE VERIFED DOMAIN NAME&gt;</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>If you want to find out more just call:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">PS &gt; Get-Help .\SetupClientSideSCP.ps1 </pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>Finally</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p><strong>ADFS -</strong> The <a href="https://docs.microsoft.com/en-us/azure/active-directory/devices/hybrid-azuread-join-control">Microsoft documentation</a> states that you have to apply the reg key first to your ADFS server(s) (if you are using ADFS). Personally I do not fully understand and agree on this requirement and I cannot remember that this was documented before. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>But if possible just hybrid-join your ADFS Server(s). Hybrid-joining Windows Server is only working for Windows Server 2016+ / ADFS 4.0+ (Windows Server 2012 and below cannot be hybrid joined). </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><strong>Restart - </strong>After you have added the reg key you should restart your clients. The rest of the setup for a successful hybrid-join pilot is well documented by Microsoft and I assume you have covered these steps before. Just a quick checklist what must be in place:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li>If you are using a proxy for connecting to the internet the config must be applied through WPAD to your clients. If using proxy authentication this must be disabled for the needed endpoints to successfully join a device to Azure AD</li>
<li>Azure AD connect is setup correctly and syncing the your (pilot) clients. This is needed if you want the lifecycle for your devices synced from on-premise to the cloud.</li>
<li>If you are using non routable upn-suffixes or using alternate login id you should check the required Windows 10 Version is installed on your pilot machines</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
