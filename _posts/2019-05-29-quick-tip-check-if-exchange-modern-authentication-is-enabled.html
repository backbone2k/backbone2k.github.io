---
layout: post
title: 'Quick tip: Check if Exchange modern authentication is enabled'
date: 2019-05-29 21:20:38.000000000 +02:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Authentication
- Exchange
- Quick tip
tags:
- hybrid
- O365
- office 365
- script
meta:
  _wpas_skip_20268272: '1'
  _publicize_job_id: '31308705273'
  timeline_notification: '1559157642'
  publicize_linkedin_url: ''
  _publicize_done_21846260: '1'
  _wpas_done_22590086: '1'
author:
  login: cbaumgartner80
  email: wordpress@treegardner.de
  display_name: cbag
  first_name: Christian
  last_name: Baumgartner
permalink: "/2019/05/29/quick-tip-check-if-exchange-modern-authentication-is-enabled/"
---
<p><!-- wp:paragraph --></p>
<p>In my day to day business I often need to know if a tenant or an on-premise Exchange 2016 environment is enabled for modern authentication. Most of the time I need this information at a point in time, where I do not have access to the customers Exchange (Online) environment - and most of the time even the customer does not know if the tenant or the on-premise environment are running modern or not. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>For Exchange Online this is often an issue, because older Tenants had the modern authentication turned off by default. Only tenants created at the end of 2017 or later have it enabled by default. But to check if this is still the case is always a good idea.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>With this little script, you can check Exchange Online and every Exchange on-premise where you can reach the EWS endpoint if modern authentication (OAuth2) is enabled or not, without having any credentials!</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>It is important to understand for on-premise Exchange Server: This method will not tell you if everything is set up correctly for Hybrid modern authnetication to work - but it is a starting point :-)</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading --></p>
<h2>How does it work?</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Ok, sounds like magic to check a setting without even have credentials? No - not really - we just use the fact, that trying to send a request for modern authentication to Exchange will be handled different depending if modern authentication is enabled or not.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>The endpoint we are using is the EWS endpoint. For Office 365 this is always</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">https://outlook.office365.com/EWS/Exchange.asmx</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>If you are sending a simple POST request to this endpoint with some defined headers you can actually learn what configuration is set. The following headers must be sent to EWS</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted"><code>"Authorization"="Bearer"</code>
<code>"Content-Type"="text/xml"</code>
<code>"X-User-Identity"="&lt;username&gt;@&lt;domain&gt;</code>
<code>"X-EWS-TargetVersion"="2016_11_20"</code></pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>You do not need an existing user to put in the X-User-Identity header. But the domain is important part. If you want to check the tenant contos.com you have to provide a username something@contoso.com</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>In my script i will just generate a GUID for the local part.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>If you send these headers as a POST request to the O365 EWS endpoint, Exchange will tell us if  it can deal with bearer authentication or not. Exchange should answer this request with a 401 unauthenticated response - but that is not the part we are interested. We have to look more closely into the response headers. If there is a header x-ms-diagnostics send back to our client, chances are high that modern auth is disabled. But to be 100% sure we have to evaluate the value in this header. If it tells us, that "flighting is not enabled" you know for sure, that this tenant/Exchange on-premise is not configured for handling modern auth!</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading --></p>
<h2>Using invoke-webrequest in PowerShell</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>If you want to do this check in PowerShell you will mostly use invoke-webrequest. This is fine as long as you know how to receive the response headers. Because the invoke-webrequest will throw an error if Exchange requires authentication (401) we can not get directly to the header. So we have to wrap up the request in a try-catch-block:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:code --></p>
<pre class="wp-block-code"><code>#We want to use a random username - not trying to hit a real user.
$randomUser = &#091;GUID]::NewGuid().ToString()
$Domain = '&lt;enter your domain name here - eg. contoso.com&gt;'

$headers = @{
    "Authorization"="Bearer"
    "Content-Type"="text/xml"
    "X-User-Identity"="$randomUser@$Domain"
    "X-EWS-TargetVersion"="2016_11_20"
}

$uri = "https://outlook.office365.com/EWS/Exchange.asmx"

$error.clear()

Try {
   $result = Invoke-WebRequest -Uri $URI -Headers $headers -Method Post

} Catch &#091;System.Net.WebException]{

    #... with calling the Response in the System.Net.HttpWebResponse class.
    &#091;System.Net.HttpWebResponse]$result = &#091;System.Net.HttpWebResponse] $_.Exception.Response
    $httperrorcode  = $result.StatusCode.Value__

    #we are interessted in the 401 NotAuthenticated
    If ($httperrorcode = 401) {

        Write-Host "Server returned 401 - lets take a look into response headers" -ForegroundColor Yellow

        If ($result.Headers -contains "x-ms-diagnostics") {
            Write-Host "x-ms-diagnostics header found. Looking if flighting is enabled...."

            $diagnosticsHeaderContents = ($result.Headers&#091;"x-ms-diagnostics"]).Split(";")

            Foreach ($item in $diagnosticsHeaderContents) {
                If ($item -like "*flight*") {
                    Write-Host $item -ForegroundColor Yellow
                }
            }
        } Else {
            Write-Host "No x-ms-diagnostics header found. Looks like modern auth is active" -ForegroundColor Green
        }
    }
}</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:heading --></p>
<h2>Finally</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>So next time you quickly want to know, if a Office 365 tenant has enabled modern authentication or not, you can check this setting without any credentials. The only thing you need to know is one of the configured domains that is used.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
