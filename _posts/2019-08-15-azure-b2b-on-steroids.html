---
layout: post
title: Azure B2B on steroids
date: 2019-08-15 16:54:41.000000000 +02:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Authentication
- Azure AD
- Identity
- Migration
tags:
- AAD Connect
- B2B
- Guest
- hybrid
- Steroids
- Two-Leg Authentication
meta:
  _publicize_job_id: '34119973441'
  timeline_notification: '1565880883'
  publicize_linkedin_url: ''
  _publicize_done_21846260: '1'
  _wpas_done_22590086: '1'
author:
  login: cbaumgartner80
  email: wordpress@treegardner.de
  display_name: cbag
  first_name: Christian
  last_name: Baumgartner
permalink: "/2019/08/15/azure-b2b-on-steroids/"
excerpt: In my new blog post I will teach you how to put your Office 365 guest users
  on steroids and gain back control!
---
<p><!-- wp:paragraph --></p>
<p>In this post I will cover some advanced ways to improve Azure B2B usage for day-to-day scenarios.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"align":"right","id":286} --></p>
<div class="wp-block-image">
<figure class="alignright"><img src="{{ site.baseurl }}/assets/2019/08/image-9.png" alt="" class="wp-image-286" /></figure>
</div>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p>We start with some basic tweaks: Change the userType and add B2b users to Exchange Online</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>After this little warm up we will super charge your B2b users and put them on steroids :-) </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3>Change the UserType attribute</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Currently not widely known but  definitely powerful is the possibility to change the attribute <strong>userType </strong>from <em>guest </em>to <em>member</em>. Microsoft Office 365 services are using this attribute to restrict some rights you normally don't want your externals or partners to have. But what if you invite B2B users from another tenant that also belongs to your company? Wouldn't it be great if these users could see all users in Microsoft Teams, do a search everywhere in SharePoint Online or just browse the Azure AD? By setting userType to 'Member' you get exactly that. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>The attribute can easily be changed with the AzureAD PowerShell module:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">PS&gt; Get-AzureAdUser -UserPrincipalName j.doe_contoso.com#EXT#@t1.onmicrosoft.com | Set-AzureAdUser -UserType 'Member'</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>Of course, you can change this value also back to 'Guest' if you want the user to be restricted again.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3>Add Azure B2B users to Exchange Online Global Address List or distribution groups</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>When you invite a guest user to your Azure AD tenant, Microsoft will always provision an identity to your tenant. Most of the time I refer to this as a shadow account for the actual users that is authenticating within another tenant. This shadow account is also synced to Exchange Online because Microsoft creates this Azure B2B identity as mail enabled user. If you want to put these identities in a distribution group or if you want to make it visible in the GAL  you can easily to this by connecting to your Exchange Online and fire up some PowerShell commands:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>To make the user visible in the GAL call this command</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">PS&gt; Get-MailUser j.doe@contoso.com | Set-MailUser -HiddenFromAddressListsEnabled $False</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>If you want to add John Doe to the distribution group 'AllB2bUser' use this command</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">PS&gt; Get-DistributionGroup -Identity AllB2bUser | Add-DistributionGroupMember -Member j.doe@contoso.com</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>If you are running a hybrid Exchange environment and have not yet moved all your users to Exchange Online you should be very careful with this approach. You could end up having different contents in your GAL. Also while you have hybrid identities you cannot modify synced distribution groups. But you can add guest users to Office365 groups. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>But If you want to get rid of these hurdles, my Hybrid Azure B2B user process will help you with that!</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3>Make your Azure B2B users go hybrid</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Most of you will already cover external users in your on-prem environment by creating AD users for them. These accounts often get challenging when you are going to use Office 365 for collaboration with your externals. If you don't want to license them with a SharePoint Online plan or an Office 365 E1 you maybe want to guest invite these external users to your Azure AD tenant. Azure B2B will help you achieve this with ease. But doing so can lead to new challenges. It is a good idea to filter the on-prem AD external accounts so you don't end up with two identities in Azure AD for the same person. This would totally confuse your end users and reduce usability and acceptance in the business. Shown in the below picture you see what happens when you don't filter the on-prem user. You will end up having two John Does in your tenant. If a user looks up John Doe in Microsoft Teams he will see two identities - one 'internal' and one guest. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"align":"center","id":264} --></p>
<div class="wp-block-image">
<figure class="aligncenter"><img src="{{ site.baseurl }}/assets/2019/08/image.png" alt="" class="wp-image-264" /></figure>
</div>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p>But what if you have mail-enabled the external accounts in Active Directory to show up in the Exchange on-prem GAL or to be member in a distribution group? Skipping these users from syncing into Azure AD will break workflows in Exchange Online. Again a path that will lead to a decreased user acceptance.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>As you can see in the following picture, the Exchange distribution group <em>all_externals</em> will have different memberships in Exchange Online compared to on-prem when you filter out some or all of your external accounts to be synced to Azure AD</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"align":"center","id":266} --></p>
<div class="wp-block-image">
<figure class="aligncenter"><img src="{{ site.baseurl }}/assets/2019/08/image-1.png" alt="" class="wp-image-266" /></figure>
</div>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p>One possible way out of this is described in this great docs article:  <a href="https://docs.microsoft.com/en-us/microsoft-identity-manager/microsoft-identity-manager-2016-graph-b2b-scenario">https://docs.microsoft.com/en-us/microsoft-identity-manager/microsoft-identity-manager-2016-graph-b2b-scenario</a>. So technically what it describes is installing MIM and syncing the Azure B2B users back to your on-premise environment.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>But there are some flaws in this I think:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li>You have to install and maintain a MIM sync service. If not have one already running  this is a huge challenge</li>
<li>The management for these users has to be done Azure AD - so if you have hybrid users this will break your normal processes </li>
<li>It gets even more complex when you want these B2b users also in your on-prem Exchange because you have create all the provisioning rules into MIM</li>
<li>Onboarding existing AD users puts even more complexity in to the whole process</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p>So I was thinking: why not using what is already there? If you have deployed a hybrid setup with  AAD Connect why not use this tool for linking the Azure B2B identities to on-prem?. Of course I do not want AAD Connect to create new on-premise accounts, I just want to do some minor changes to Azure AD connect rules. The goal should look something like this with minimal effort:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"align":"center","id":269} --></p>
<div class="wp-block-image">
<figure class="aligncenter"><img src="{{ site.baseurl }}/assets/2019/08/image-2.png" alt="" class="wp-image-269" /></figure>
</div>
<p><!-- /wp:image --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>Import B2B user into AAD Connect Metaverse</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>First things first - the following description only works if your on-prem external accounts NOT synced to AzureAD. If this is the case you can just go on. Otherwise you first have to deprovision these users from Azure AD and make sure your empty the AAD recycle bin. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Normally the Azure B2b identites are not imported by Azure AD Connect. This is because these identities do not have a source anchor / immutableId setup. So first we have to set an immutableId - that is straight forward. All you need is the AzureAD PowerShell module and run:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">PS&gt; Get-AzureAdUser -UserPrincipalName j.doe_contoso.com#EXT#@fabrikam.onmicrosoft.com | Set-AzureAdUser -ImmutableId &lt;string&gt;</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>But of course you have to not just pick a random string, you have to use a value that will be linking the corresponding on-prem account with this particular Azure B2B identity. If you not have changed the default AAD Connect setup, normally the on-prem ObjectGUID is the default source anchor. But we have to convert this value in a base64 representation. You can use the following lines of code to do the job</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">PS&gt; $AzureB2BUpn = 'j.doe_contoso.com#EXT#@fabrikam.onmicrosoft.com'
PS&gt; $OnPremUsername = 'jdoe'

PS&gt; $UserGuid =  ([GUID](Get-ADuser $OnPremUsername -Properties ObjectGUID).ObjectGUID).ToByteArray()
PS&gt; $ImmutableID = [System.Convert]::ToBase64String()

PS&gt; Get-AzureAdUser -UserPrincipalName $AzureB2BUpn | Set-AzureAdUser -ImmutableId $ImmutableId</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>After setting the ImmutableId with your next sync cycle you should see that AAD Connect will import the identity into the Metaverse.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>Adding logic to avoid accidential sync of external before an Azure B2B account is prepared</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>The next part in the puzzle is, we have to etablish a process in AD/ AAD Connect that only exports external users when a corresponding Azure B2B object is available and prepared with an immutableId. For this I recommend the usage of two attributes we use for the flow. One should be an attribut that helps us identify external user accounts. Maybe you already have something in place for that. The second one will be populated after the Azure B2B preparations are done. For this post I will use the following two attributes:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li>employeeType</li>
<li>customAttribute1</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p>With this two attributes we can now create a custom rule in AAD Connect that will make sure that external users that have no corresponding and prepared Azure B2B identity get not synced. The details why this is important will covered later on.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>To filter out these users we can use the build in Metaverse attribute cloudFiltered. If this value is True for a given user the rules shipping with AAD Connect will not Export the user to Azure AD. So creating create a new Inbound rule:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><strong>Basic</strong> <strong>settings</strong></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li><strong>Name:</strong> In from AD - Cloud filter Non-Employee </li>
<li><strong>Connected system: </strong>AD</li>
<li><strong>Connected system type:</strong> user</li>
<li><strong>Metaverse type:</strong> person</li>
<li><strong>Link type:</strong> Join</li>
<li><strong>Precedence</strong>: &lt;100 </li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p><strong>Scoping filter</strong></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li>employeeType EQUALS 'External' &amp;&amp; CustomAttribute1 ISNULL&nbsp; </li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p><strong>Tranformations</strong></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li> <strong>Flow type:</strong> Constant</li>
<li> <strong>Target attribute:</strong> cloudFiltered</li>
<li> <strong>Source:</strong> True</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p>So what this rules does is setting the attribute cloudFiltered to True for all users that have employeeType 'External' and not set a value for CustomAttribute1. In reverse this means, as soon as our preparation is done and we write back something into customAttribute1 the sync and export will start to flow exactly like in this illustration:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"align":"center","id":288} --></p>
<div class="wp-block-image">
<figure class="aligncenter"><img src="{{ site.baseurl }}/assets/2019/08/image-10.png" alt="" class="wp-image-288" /></figure>
</div>
<p><!-- /wp:image --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>Advantages of Hybrid Azure B2B identites </h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>In that moment AAD Connect established the attribute flow between on-prem and Azure AD you instantly get a lot of benefits. This list is not a complete list of features. Instead I just wanted to highlight some of them.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li><strong>Lifecycle </strong>Most companies have some sort of working lifecycle to their accounts in Active Directory. So maybe some of your external user accounts gets deactivated or deleted automatically. After connecting the B2B object to your external AD accounts you will extend this lifecycle to the B2B object. Something a lot of my customers demand.</li>
<li><strong>Mail attributes</strong> If your on-prem accounts are mail enabled and part of distribution groups AAD connect will now reflect this to the Azure B2B object. </li>
<li><strong>Attributes </strong>Most companies maintain the attributes of their external accounts. Beside first and last name you will find phone numbers, managers and address attributes to be filled correctly. Now these attributes getting applied to the Azure B2B user and you have on source of truth.</li>
<li><strong>Azure AD app proxy </strong>If you are running on-prem services like an web application running on IIS you now can publish this app through the app proxy in Azure AD. Doing this you are now able to let your Azure B2b users access these application with SSO. This is possible through Kerberos constraint delegation. How to set this up is described at the end of <a href="https://docs.microsoft.com/en-us/microsoft-identity-manager/microsoft-identity-manager-2016-graph-b2b-scenario">this </a>page</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>Two-leg authentication</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>One thing I have not mentioned before but it is really awesome: With the Hybrid Azure B2B user you get something  I call the two-leg authentication. The two-leg authentication or TLA is basically a nice side effect of this setup - but lets explain this a little bit more in detail. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>When you create an guest user invite and this invitation is redeemed by the user Microsoft will stamp an alternateSecurityId to the Azure B2B object in your tenant. This is the link for the object between your tenant and the home tenant of the Azure B2B user: </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"align":"center","id":275} --></p>
<div class="wp-block-image">
<figure class="aligncenter"><img src="{{ site.baseurl }}/assets/2019/08/image-4.png" alt="" class="wp-image-275" /><br />
<figcaption>The actual values are not show like this - just for explanation purpose</figcaption>
</figure>
</div>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p>So every time a user authenticates in the home tenant and switch to your tenant to access a shared document, Microsoft will map the user with the help of this attribute. Currently there is no way to manually update or remove the alternateSecurityId that is pointing to the source user. <strong>This is why it so important to first create the Azure AD B2b object by invitation. This is currently the only way to stamp an alternateSecurityId onto it! </strong></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>But hey - that is no a "two-leg", right? Absolutely! But in that moment, we link our on-prem account to the Azure B2B identity a second way of authentication will be established. And it does not matter how you are authenticating against Azure AD - this works for all three scenarios: ADFS, Password hash sync and Passthrough authentication!</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"align":"center","id":277} --></p>
<div class="wp-block-image">
<figure class="aligncenter"><img src="{{ site.baseurl }}/assets/2019/08/image-5.png" alt="" class="wp-image-277" /></figure>
</div>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p>So to make things clear: You now have a super charged user in Azure AD that can authenticate from two sides: Through an username and password that is provided by you and through the Azure B2B authentication process. Cool, isn't it? </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>But why we should have two ways of authentication you may think? One big benefit of this approach is for a merge or acquisition scenario. Before the users are migrated you start collaborating with them through Azure B2B. When time goes on, you link them as described. The user now can access Office 365 through another way without loosing their access rights or data (e.g. Teams 1:1 chats are preserved). If you like you can even strengthen the collaboration more by setting the userType from Guest to Member (You learned this in the warming up at the beginning of this post). If you successfully migrated the user you can raise a ticket at Microsoft to remove the alternateSecurityId at the end.<strong> So actually the hybrid Azure B2B is an awesome way to migrate users from one Azure AD tenant to another! </strong></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>Polish the process</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>To make this whole hybrid B2B process more reliable you should setup a process that will deal with onboarding new external accounts on-prem. I personally create an Azure B2B identity for every new external user automatically. By using the invite manager API you can build a logic to invite a user without actually sending an invitation mail every time. With this flow you prestage your Azure AD object to be onboarded later via Azure B2B. A sample call to the invitation API could look like the following code (I will not cover how to obtain an access token - there are ton of blogs covering this task :-) ). If you want to dig deeper into the invitations API you will find everything <a href="https://docs.microsoft.com/en-us/graph/api/resources/invitation?view=graph-rest-1.0">here</a>.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">$HeaderParameters = @{
   "Authorization"="Bearer $(GetAccessToken)"
} 

#Specify the URI to call and method
$InviteApiUri = "https://graph.microsoft.com/v1.0/invitations"
$method = "POST"
$body = @{
    "invitedUserEmailAddress"= "john.doe@contoso.com",
    "sendInvitationMessage": false
}

# Run Graph API query

$query = Invoke-WebRequest -Method $method -Uri $uri <code>
   -ContentType "application/json" -Headers $HeaderParameters</code> `
   -Body ($body | ConvertTo-Json)</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>After creating the B2b object the invoke will give us the object id of the newly created object. This can easily be written back to the on-prem AD account</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">$B2bObjectId = ($query.Content | ConvertFrom-Json).invitedUser.Id

Set-AdUser -Identity jdoe -Replace @{customAttribute1=$B2bObjectId}</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>Special scenario: Cloud only / no AAD Connect</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>In case your tenant is already 100% cloud and you do not have an AAD Connect you can still pimp your Azure B2B identities! In this case I am sure you already have some sort of user lifecycle in place. If you want to provide an alternate way to sign into your tenant you can just replace the UPN and set a password for your Azure B2B users with the AzureAD PowerShell Module</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">PS&gt; $B2bUser = Get-AzureAdUser -UserPrincipalName                  j.doe_contoso.com#EXT#@fabrikam.onmicrosoft.com

PS&gt; $B2bUser | Set-AzureAdUser -UserPrincipalName 'john.doe@fabrikam.com'
PS&gt; Set-AzureADUserPassword -ObjectId $B2bUser.ObjectId -Password ('MyPassword' | ConvertTo-SecureString -AsPlainText -Force)</pre>
<p><!-- /wp:preformatted --></p>
