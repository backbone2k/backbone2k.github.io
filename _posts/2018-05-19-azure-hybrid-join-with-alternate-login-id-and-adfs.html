---
layout: post
title: Azure hybrid join with alternate login id and ADFS
date: 2018-05-19 19:57:40.000000000 +02:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Azure AD
- Hybrid Join
tags:
- ADFS
- hybrid
- join
meta:
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '18031154349'
  timeline_notification: '1526752661'
  publicize_linkedin_url: https://www.linkedin.com/updates?discuss=&scope=81344172&stype=M&topic=6403664794750058496&type=U&a=437k
  _publicize_done_20172161: '1'
  _wpas_done_20254079: '1'
author:
  login: cbaumgartner80
  email: wordpress@treegardner.de
  display_name: cbag
  first_name: Christian
  last_name: Baumgartner
permalink: "/2018/05/19/azure-hybrid-join-with-alternate-login-id-and-adfs/"
---
<p>A cool feature when you are dealing with Office 365 and Azure AD and you also still have a lot on-prem stuff in your business is to hybrid join your devices. Your Windows device is joined not only into the old fashioned Active Directory but also into Azure AD simultaneously. There are several reasons why you should consider to join the device also into Azure AD:</p>
<ul>
<li>If you plan to manage the devices with Intune</li>
<li>If you want to give a real SSO to your users when accessing Application protected through Azure AD (for example O365 apps like Outlook or SharePoint Online)</li>
<li>If you want to be more flexible when using conditional access</li>
</ul>
<p>In my case the SSO was one of the major reason why I was playing around with this for some time now. Unfortunately I stumbled across a nasty problem with exactly this feature.</p>
<p><!--more--></p>
<p>So as always in such a case I start to read all the documentation, look into the event logs and try to search within the community to see if anyone else came across the same problem.</p>
<p>One very good resource (and sadly the only one except the official documentation) is the blog of Jairo Cadena (<a href="https://jairocadena.com" target="_blank" rel="noopener">https://jairocadena.com</a>). Reading the information how hybrid join is working behind the scenes was very helpful.</p>
<p>But even with this knowledge I was not able to solve the issue by myself - but lets start from the beginning....</p>
<h4>Let me explain the issue</h4>
<p>We have a registered and federated domain @company.com that we are using for the username in Azure AD and we have a different, non public UPN suffix @domain.local in our on premise Active Directory.</p>
<p>After successfully logging into the hybrid joined computer with an Active Directory user (ex. john@domain.local) running the command</p>
<p>[code language="powershell"]dsregcmd /status[/code]<br />
I always get an odd result, that two important values in the user state, wich are signaling if SSO is working or not, are saying</p>
<p>[code language="powershell"]WamDefaultSet : NO<br />
AzureAdPrt : NO[/code]</p>
<p>There is only one <a href="https://docs.microsoft.com/en-us/azure/active-directory/device-management-troubleshoot-hybrid-join-windows-current" target="_blank" rel="noopener">Microsoft article </a>that gives you a clue what the reason could be - but no definitive answer how to find out what the actual problem is.</p>
<ul>
<li>Bad storage key (STK) in TPM associated with the device upon registration (check the KeySignTest while running elevated).</li>
<li>Alternate Login ID</li>
<li>HTTP Proxy not found</li>
</ul>
<p>I was a little surprised about the second point - alt-login-id. Does this mean, if you are using alternate login id in your environment, single sign on is not working at all? I could not believe this and so I asked some guys in my network who are more experienced than I am and they said to me that it should work also with alt-login-id. Ok so now I am confused and also excited to solve this problem in my configuration ;-)</p>
<p>Always a good start when dealing with this sort of problem is to install Fiddler and Wireshark. But this time capturing traffic was not so easy - because also LOCAL SYSTEM is involved making calls to public and ADFS endpoints</p>
<h3>Setup the lab</h3>
<p>I don't want to go into every detail how to setup Fiddler and Wireshark but I will give some valuable tips to setup up your environment right. First grab the following tools</p>
<ul>
<li>Fiddler</li>
<li>Wireshark (you can also use netsh trace and Microsoft Message Analyzer - I prefer Wireshark)</li>
<li>psexec from the Sysinternals Suite</li>
</ul>
<p>Install all the tools and extract the psexec executable to some location of your choice</p>
<p>Before we start to capture the traffic we have to prepare the environment to pass through Windows authentication to ADFS correctly. This is only needed if Fiddler is running on the same machine the requests are coming from. There is a security measure in place called LoopbackCheck - we have to disable it to get authentication through Fiddler to work. You will get more information about DisableLoopCheck at this <a href="https://support.microsoft.com/en-us/help/926642/error-message-when-you-try-to-access-a-server-locally-by-using-its-fqd" target="_blank" rel="noopener">Microsoft support article</a>. When you have opened the registry go the following subkey:</p>
<p>[code language="text"]HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa[/code]</p>
<p>and create a new DWORD Value. Give it the name <strong>DisableLoopbackCheck a</strong>nd set the value to<strong> 1</strong></p>
<p>Restart your computer to apply the change.</p>
<p>Afterwards you start a command shell as administrator, go to the extracted psexec and run the following command</p>
<p>[code language="bash"]psexec.exe -i -s cmd.exe[/code]</p>
<p>This will launch a cmd.exe in the context of SYSTEM. Next we have to point the system to use the fiddler proxy. So type into the new shell the following</p>
<p>[code language="bash"]netsh winhttp set proxy 127.0.0.1:888[/code]</p>
<p>Start Fiddler in the background and check that "Automatic authentication" and capture https traffic is enabled.</p>
<p>Back in the shell of local system run the commands</p>
<p>[code language="bash"]dsregcmd /leave[/code]</p>
<p>This will unregister the device from Azure AD. I had sometimes errors while leaving when capturing traffic with Fiddler. Just ignore them. Afterwards we run the registration again. I would suggest to increase the buffer values for the console window - otherwise you will not be able to scroll up again.</p>
<p>[code language="bash"]dsregcmd /debug[/code]</p>
<p>You should see something happen in your Fiddler and now you can excaimine the whole communication.</p>
<p>If you wan't to catch the traffic from user login just switch the user and let Fiddler run in the background.</p>
<h3>Analyzing the results</h3>
<p>What I could observe with Fiddler was a difference in the behavior from what I have learned from Jairo's blog - the Cloud AP Azure AD plug-in for authentication was not going to ADFS diectly (to get the SAML token) but instead is pointing to login.microsoftonline.com and passing the on-prem UPN suffix to it.</p>
<p>[code language="text"]GET https://login.microsoftonline.com/common/UserRealm/user%40domain.local?api-version=1.0 HTTP/1.1[/code]</p>
<p>Of course Azure AD does not know the user realm @domain.local and cannot proceed and redirect the user to our local ADFS STS-IDP. My first thoughts where that the hybrid join was not done correctly and so the local system is not pointing the plug-in directly to ADFS.</p>
<h3>The Service Connection Point</h3>
<p>A key role in the hybrid join process plays the SCP you have to create in your Active Directory. This SCP with the well known guid 62a0ff2e-97b9-4513-943f-0d221bd30080 contains two keyword attributes:</p>
<ul>
<li>azureADName:company.com</li>
<li>azureADId:72f988bf-86f1-41af-91ab-2d7cd051db47</li>
</ul>
<p>AzureADName is one of your registered domains in your Azure AD tenant with the id stored in azureADId. With this information the Windows client knows to which tenant it belongs while trying to join Azure Ad.</p>
<p>When you analyze the registration process in Fiddler you will see the following communication.</p>
<p>First it is going to the enterpriseregistration endpoint and is putting the domain from the keyword azureADName in the request URI:</p>
<p>[code language="text"]GET https://enterpriseregistration.windows.net/company.com/EnrollmentServer/contract?api-version=1.3 HTTP/1.1<br />
GET https://login.microsoftonline.com/common/UserRealm/user%40company.com?api-version=1.0 HTTP/1.1[/code]</p>
<p>So now login.microsoftonline.com knows that the user realm @company.com is a federated domain and so we get redirected to our local ADFS STS-IDP for authentication</p>
<p>[code language="text"]GET https://sts.company.com/adfs/services/trust/mex HTTP/1.1<br />
POST https://sts.company.com/adfs/services/trust/13/windowstransport HTTP/1.1<br />
POST https://sts.company.com/adfs/services/trust/13/windowstransport HTTP/1.1[/code]</p>
<p>After successful authentication we pass the SAML token to the oAuth2 endpoint to receive our refresh and access tokens for the computer at the end</p>
<p>[code language="text"]POST https://login.microsoftonline.com/common/oauth2/token HTTP/1.1<br />
... SNIP ...[/code]</p>
<p>So this looks very good - but why is SSO still not working and AzrueADPrt and WamDefaultSet still yelling no at me?</p>
<h3>The "solution"</h3>
<p>At the end I gave up. So I contacted Jairo and he helped me out very quickly - thanks a lot again for the assist! In the end it is a problem in Windows 10 RS3 and below when it comes to alternate login id. Microsoft fixed the behavior in RS4 to use the SCP also for the user login. So instead just passing the UPN suffix to the login.microsoftonline.com endpoint the process now takes the value from the keyword AzureADName in the SCP as the user realm value.</p>
<p>That leaves one question open: Why I was told that alternate login id should work before RS4? Of course you can use alt-login-id but still have a registered UPN suffix. Why you do this? I only can think of one reason why you do this because you don't want to change your UPNs but still want to be able to use your email address as the username in Azure AD. But this only works if you are using public top level domain names as UPN suffix. In my scenario this is not the case.</p>
<p>UPDATE</p>
<p>This a dsregcmd status from a successful joined and SSO capable computer/user. You can use this to compare it to your status</p>
<p>[code]&gt; dsregcmd /status</p>
<p>+----------------------------------------------------------------------+<br />
| Device State |<br />
+----------------------------------------------------------------------+</p>
<p>AzureAdJoined : YES<br />
EnterpriseJoined : NO<br />
DeviceId : 81c1a816-1306-xxxx-b788-yyyyyyyyyy<br />
Thumbprint : A712F0CB3A65B6B6CB08C83DF1C9FA79FC1BCE1C<br />
KeyContainerId : d1dc3688-xxxx-yyyy-zzzzz-0f4072ef5158<br />
KeyProvider : Microsoft Platform Crypto Provider<br />
TpmProtected : YES<br />
KeySignTest: : MUST Run elevated to test.<br />
Idp : login.windows.net<br />
TenantId : 98c8eb766-xxxx-yyyy-zzzz-26d4a9d3147<br />
TenantName :<br />
AuthCodeUrl : https://login.microsoftonline.com/98c8eb766-xxxx-yyyy-zzzz-26d4a9d3147/oauth2/authorize<br />
AccessTokenUrl : https://login.microsoftonline.com/98c8eb766-xxxx-yyyy-zzzz-26d4a9d3147/oauth2/token<br />
MdmUrl :<br />
MdmTouUrl :<br />
MdmComplianceUrl :<br />
SettingsUrl :<br />
JoinSrvVersion : 1.0<br />
JoinSrvUrl : https://enterpriseregistration.windows.net/EnrollmentServer/device/<br />
JoinSrvId : urn:ms-drs:enterpriseregistration.windows.net<br />
KeySrvVersion : 1.0<br />
KeySrvUrl : https://enterpriseregistration.windows.net/EnrollmentServer/key/<br />
KeySrvId : urn:ms-drs:enterpriseregistration.windows.net<br />
WebAuthNSrvVersion : 1.0<br />
WebAuthNSrvUrl : https://enterpriseregistration.windows.net/webauthn/98c8eb766-xxxx-yyyy-zzzz-26d4a9d3147/<br />
WebAuthNSrvId : urn:ms-drs:enterpriseregistration.windows.net<br />
DeviceManagementSrvVersion : 1.0<br />
DeviceManagementSrvUrl : https://enterpriseregistration.windows.net/manage/98c8eb766-xxxx-yyyy-zzzz-26d4a9d3147/<br />
DeviceManagementSrvId : urn:ms-drs:enterpriseregistration.windows.net<br />
DomainJoined : YES<br />
DomainName : DOMAIN</p>
<p>+----------------------------------------------------------------------+<br />
| User State |<br />
+----------------------------------------------------------------------+</p>
<p>NgcSet : NO<br />
WorkplaceJoined : NO<br />
WamDefaultSet : YES<br />
WamDefaultAuthority : organizations<br />
WamDefaultId : https://login.microsoft.com<br />
WamDefaultGUID : {B16898C6-xxxx-zzzz-yyyy-64D755DA8520} (AzureAd)<br />
AzureAdPrt : YES<br />
AzureAdPrtAuthority : https://login.microsoftonline.com/98c8eb766-xxxx-yyyy-zzzz-26d4a9d3147<br />
EnterprisePrt : NO<br />
EnterprisePrtAuthority :</p>
<p>+----------------------------------------------------------------------+<br />
| Ngc Prerequisite Check |<br />
+----------------------------------------------------------------------+</p>
<p>IsUserAzureAD : YES<br />
PolicyEnabled : NO<br />
PostLogonEnabled : YES<br />
DeviceEligible : YES<br />
SessionIsNotRemote : YES<br />
CertEnrollment : none<br />
AadRecoveryNeeded : NO<br />
PreReqResult : WillNotProvision[/code]</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>In my next post I will explain how to use alternate login id without using alternate login id :-)</p>
